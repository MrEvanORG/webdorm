{% extends 'patterns/base_dashboard.html' %}
{% load static %}

{% block title %}انتخاب اتاق{% endblock %}

{% block content %}
    <main class="dashboard-main" id="main-content">
        <header class="dashboard-top-nav">
            <button id="sidebar-toggle" class="toggle-btn" onclick="toggleSidebar()">
                <span></span><span></span><span></span>
            </button>
            <h2 class="page-title">رزرو و انتخاب اتاق</h2>
        </header>

        {% if access_denied %}
            <div class="no-room-alert" style="text-align: center; padding: 80px 20px;">
                <i class="fa-solid fa-lock" style="font-size: 4rem; color: #e74c3c; margin-bottom: 20px; display: block;"></i>
                <h3>عدم دسترسی</h3>
                {% for msg in error_messages %} <p style="color: #666;">{{ msg }}</p> {% endfor %}
            </div>
        {% else %}
            <section class="filter-section">
                <form method="GET" class="filter-form">
                    <div class="filter-group">
                        <select name="dorm">
                            <option value="">همه خوابگاه‌ها</option>
                            {% for d in dorms %}
                            <option value="{{ d.id }}" {% if request.GET.dorm == d.id|stringformat:"i" %}selected{% endif %}>{{ d.name }}</option>
                            {% endfor %}
                        </select>
                        
                        <select name="block">
                            <option value="">همه بلوک‌ها</option>
                            {% for b in blocks %}
                            <option value="{{ b.id }}" {% if request.GET.block == b.id|stringformat:"i" %}selected{% endif %}>{{ b.name }}</option>
                            {% endfor %}
                        </select>

                        <select name="floor">
                            <option value="">همه طبقه‌ها</option>
                            {% for f in floor_list %}
                            <option value="{{ f }}" {% if request.GET.floor == f|stringformat:"i" %}selected{% endif %}>طبقه {{ f }}</option>
                            {% endfor %}
                        </select>

                        <select name="price_sort">
                            <option value="">اولویت قیمت: هیچکدام</option>
                            <option value="cheap" {% if request.GET.price_sort == 'cheap' %}selected{% endif %}>ارزان‌ترین</option>
                            <option value="expensive" {% if request.GET.price_sort == 'expensive' %}selected{% endif %}>گران‌ترین</option>
                        </select>

                        <select name="capacity_sort">
                            <option value="">اولویت ظرفیت: هیچکدام</option>
                            <option value="empty" {% if request.GET.capacity_sort == 'empty' %}selected{% endif %}>خالی‌ترین‌ها</option>
                            <option value="full" {% if request.GET.capacity_sort == 'full' %}selected{% endif %}>پرترین‌ها</option>
                        </select>

                        <button type="submit" class="filter-submit-btn">اعمال فیلتر</button>
                    </div>
                </form>
            </section>

            <div class="rooms-list-horizontal">
                {% for room in rooms %}
                <div class="room-row-card">
                    <div class="room-info-side">
                        <h3>اتاق {{ room.number }}</h3>
                        <p>خوابگاه {{ room.placed_in.placed_in.name }} | بلوک {{ room.placed_in.name }} | طبقه {{ room.floor_number }}</p>
                    </div>
                    <div class="room-stats-side">
                        <div class="stat-item"><span class="label">ظرفیت</span><span class="value">{{ room.current_count }}/{{ room.capacity }}</span></div>
                        <div class="stat-item"><span class="label">قیمت</span><span class="value">{{ room.room_cost }} تومان</span></div>
                    </div>
                    <div class="room-action-side">
                        <button class="select-btn-sm" {% if room.current_count >= room.capacity %}disabled{% endif %} onclick="location.href='{% url 'view_room_' room.pk %}'">
                             {% if room.current_count >= room.capacity %}
                                تکمیل
                            {% else %}
                                مشاهده اتاق
                            {% endif %}
                        </button>
                    </div>
                </div>
                {% empty %}
                <p style="text-align: center; padding: 20px;">اتاقی یافت نشد.</p>
                {% endfor %}
            </div>

            <div class="pagination">
                {% if rooms.has_previous %}
                    <a href="?page={{ rooms.previous_page_number }}&{{ request.GET.urlencode|cut:"page=" }}" class="page-link">&laquo; قبلی</a>
                    <span class="page-link disabled" style="opacity: 0.5;">{{ rooms.previous_page_number }}</span>
                {% endif %}

                <span class="page-link active">{{ rooms.number }}</span>

                {% if rooms.has_next %}
                    <span class="page-link disabled" style="opacity: 0.5;">{{ rooms.next_page_number }}</span>
                    <a href="?page={{ rooms.next_page_number }}&{{ request.GET.urlencode|cut:"page=" }}" class="page-link">بعدی &raquo;</a>
                {% endif %}
            </div>
        {% endif %}
    </main>
</div>
{% endblock %}